# ai-lens-helper

> ì¥ì†Œë³„ ì „ì‹œí’ˆ ì´ë¯¸ì§€ë¥¼ í•™ìŠµí•˜ê³ , ì¶”ë¡  ì‹œ **ì¥ì†Œëª… + ì´ë¯¸ì§€** ì…ë ¥ìœ¼ë¡œ í•´ë‹¹ ì „ì‹œí’ˆ(í˜¹ì€ â€œì¬ì´¬ì˜ ê¶Œìœ â€)ì„ íŒë³„í•˜ëŠ” ê²½ëŸ‰ CLI/SDK.

---

## âœ¨ ì£¼ìš” ê¸°ëŠ¥ (Features)

* **CLI í•™ìŠµ íŒŒì´í”„ë¼ì¸**: í´ë”/ë©”íƒ€ì—ì„œ ìë™ ë¡œë”© â†’ ì „ì²˜ë¦¬ â†’ ì¦ê°• â†’ í•™ìŠµ/ê²€ì¦ â†’ ì²´í¬í¬ì¸íŠ¸/ë¦¬í¬íŠ¸ ì €ì¥
* **ì¶”ë¡  API/CLI**: `place + image` ì…ë ¥ â†’ ì „ì‹œí’ˆ í›„ë³´/ì‹ ë¢°ë„ ë°˜í™˜, ì„ê³„ì¹˜ ë¯¸ë‹¬ ì‹œ â€œìƒˆë¡œ ì´¬ì˜ ê¶Œê³ â€
* **ì„ë² ë”© ê¸°ë°˜ ê²€ìƒ‰ + ë¶„ë¥˜ í•˜ì´ë¸Œë¦¬ë“œ**: ë¼ë²¨ ì¶”ë¡ ì˜ ê²¬ê³ ì„±ê³¼ OOD(ì „ì‹œí’ˆ ì™¸ë¬¼ì²´) ê±°ì ˆ(Reject) ì„±ëŠ¥ ê°•í™”
* **ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬**: ì´ë¯¸ì§€ ìˆ˜/í•´ìƒë„/ì¤‘ë³µ ê²€ì‚¬, í´ë˜ìŠ¤ ë¶ˆê· í˜• ê²½ê³ 
* **ëª¨ë¸/ë°ì´í„° ë²„ì €ë‹**: `semver` + ë©”íƒ€(JSON) ê¸°ë¡, ì¬í˜„ ê°€ëŠ¥í•œ ëŸ°(Seed ê³ ì •, í™˜ê²½ ìŠ¤ëƒ…ìƒ·)
* **ê²½ëŸ‰ ë°°í¬**: ONNX/TorchScript ë‚´ë³´ë‚´ê¸°, CPUÂ·Edge ìš°ì„  ì„¤ê³„

---

## ğŸ“¦ ì„¤ì¹˜ (Installation)

```bash
pip install ai-lens-helper
# or (ê°œë°œ)
pip install -e .[dev]
```

---

## ğŸ—‚ï¸ ë°ì´í„° ë””ë ‰í„°ë¦¬ ê·œì•½ (Dataset Layout)

```
./data/
  A/
    ã„±/
      img_001.jpg
      ... (ìµœì†Œ 10ì¥ ê¶Œì¥)
    ã„´/
    ...
  B/
  C/
```

* í´ë”ëª…: **ì¥ì†Œ/ì „ì‹œí’ˆ**
* ê° ì „ì‹œí’ˆ ìµœì†Œ 10ì¥, ë‹¤ì–‘í•œ ê°ë„/ê±°ë¦¬/ì¡°ëª… í¬í•¨ ê¶Œì¥
* (ì„ íƒ) `metadata.json`: ì´¬ì˜ê¸°ê¸°/ë‚ ì§œ/ë¼ë²¨ ì„¤ëª… ë“±

---

## ğŸš€ ë¹ ë¥¸ ì‹œì‘ (Quickstart)

### 1) í•™ìŠµ

```bash
ai-lens train \
  --data-root ./data \
  --place A --place B --place C \
  --backbone vit_b16 \
  --epochs 20 --batch-size 32 \
  --save-dir ./runs/2025-10-16
```

ì˜µì…˜ ìš”ì•½:

* `--data-root`: ë°ì´í„° ë£¨íŠ¸ ê²½ë¡œ
* `--place`: ëŒ€ìƒ ì¥ì†Œ(ì—¬ëŸ¬ ê°œ ê°€ëŠ¥)
* `--backbone`: `vit_b16|resnet50|efficientnet_b3|convnext_tiny`
* `--epochs`, `--batch-size`, `--lr`, `--img-size`
* `--embedding`: ì„ë² ë”© ì°¨ì› (ì˜ˆ: 512)
* `--loss`: `ce|arcface|triplet`
* `--export-onnx`: ONNX ë‚´ë³´ë‚´ê¸° ì—¬ë¶€

### 2) ì¶”ë¡  (ë‹¨ì¼ ì´ë¯¸ì§€)

```bash
ai-lens infer \
  --model ./runs/2025-10-16/best.ckpt \
  --place A \
  --image ./sample.jpg \
  --reject-threshold 0.62 \
  --topk 3
```

ì¶œë ¥ ì˜ˆì‹œ(JSON):

```json
{
  "place": "A",
  "predictions": [
    {"item": "ã„±", "score": 0.93},
    {"item": "ã„´", "score": 0.71},
    {"item": "ã…", "score": 0.40}
  ],
  "decision": "accept",
  "selected_item": "ã„±",
  "confidence": 0.93
}
```

ì„ê³„ì¹˜ ë¯¸ë‹¬ ì‹œ:

```json
{
  "place": "A",
  "predictions": [
    {"item": "ã„±", "score": 0.55},
    {"item": "ã„´", "score": 0.50}
  ],
  "decision": "recollect",
  "message": "ì „ì‹œí’ˆì´ ì•„ë‹Œ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤. ì´ˆì /êµ¬ë„/ì¡°ëª… ê°œì„  í›„ ì¬ì´¬ì˜ í•´ì£¼ì„¸ìš”.",
  "hints": ["ì‘í’ˆì´ í”„ë ˆì„ ì¤‘ì•™ì— ì˜¤ë„ë¡", "ë°˜ì‚¬/ê¸€ë ˆì–´ ì¤„ì´ê¸°", "ë” ê°€ê¹Œì´ ì´¬ì˜"]
}
```

### 3) ë°°ì¹˜ ì¶”ë¡ (í´ë”)

```bash
ai-lens infer-batch \
  --model ./runs/2025-10-16/best.ckpt \
  --place A \
  --input-dir ./captures/A \
  --output ./captures/A_results.jsonl
```

---

## ğŸ”§ Python SDK

```python
from ai_lens_helper import Lens

lens = Lens(model_path="./runs/2025-10-16/best.onnx")
result = lens.infer(place="A", image_path="./sample.jpg", reject_threshold=0.62)
print(result.decision, result.selected_item, result.confidence)
```

---

## âš™ï¸ êµ¬ì„±(ì„¤ì •) íŒŒì¼ ì˜ˆì‹œ

```yaml
# configs/default.yaml
seed: 42
img_size: 224
backbone: vit_b16
optimizer: adamw
lr: 3e-4
weight_decay: 0.05
scheduler: cosine
loss: arcface
embedding_dim: 512
augment:
  random_resized_crop: true
  color_jitter: 0.2
  horizontal_flip: true
  gaussian_blur: true
reject:
  threshold: 0.62
  min_top1_margin: 0.12
export:
  onnx: true
  opset: 17
```

---

## ğŸ§ª í‰ê°€ (Evaluation)

* **Split**: Stratified K-fold(5x) + ì¥ì†Œë³„ Holdout(ì‹ ê·œ ë°©ë¬¸ ì¼ë°˜í™” ì²´í¬)
* **ì§€í‘œ**: Top-1/Top-3 Acc, mAP, AUROC(Reject), EER, FPR@TPR
* **ë¦¬í¬íŠ¸**: `runs/*/report.html` (í˜¼ë™í–‰ë ¬, PR/ROC, ì„ë² ë”© t-SNE/UMAP)

---

## ğŸ› ï¸ ì—ëŸ¬ ì½”ë“œ

| ì½”ë“œ   | ì˜ë¯¸             | í•´ê²°                            |
| ---- | -------------- | ----------------------------- |
| E100 | ë°ì´í„° ë ˆì´ì•„ì›ƒ ë¶ˆì¼ì¹˜   | `data/place/item/*.jpg` êµ¬ì¡° ì ê²€ |
| E110 | í´ë˜ìŠ¤ë‹¹ ì´ë¯¸ì§€ ë¶€ì¡±    | ê° ì „ì‹œí’ˆ â‰¥10ì¥ ìˆ˜ì§‘                 |
| E200 | ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨       | ê²½ë¡œ/ê¶Œí•œ/ë²„ì „ í™•ì¸                   |
| E310 | Reject ì„ê³„ì¹˜ ë¯¸ì„¤ì • | `--reject-threshold` ì§€ì •       |

---

## ğŸ”­ ë¡œë“œë§µ

* ëª¨ë°”ì¼ ì˜¨ë””ë°”ì´ìŠ¤( CoreML / NNAPI ) ë‚´ë³´ë‚´ê¸°
* í•˜ë“œ ë„¤ê±°í‹°ë¸Œ ë§ˆì´ë‹ ìë™í™”
* ë©€í‹°ì¥ì†Œ ë™ì‹œ ì¶”ë¡  + ìºì‹±
* ì˜¨-ì‚¬ì´íŠ¸ ì¦ë¶„í•™ìŠµ(ì†ŒëŸ‰ ì‹ ìƒ˜í”Œë¡œ ì—…ë°ì´íŠ¸)

---

## ğŸ“ ë¼ì´ì„ ìŠ¤

MIT

---

# PLAN.md â€” ê°œë°œ ìƒì„¸ ê³„íš

## 1. ë¬¸ì œ ì¬ì •ì˜

* ì…ë ¥: (ì¥ì†Œëª…, ì´ë¯¸ì§€)
* ì¶œë ¥: {ì „ì‹œí’ˆ ë¼ë²¨, ì‹ ë¢°ë„, ê²°ì •(accept | recollect), ì´ìœ /íŒíŠ¸}
* ì œì•½: ì „ì‹œí’ˆ ì™¸ ë¬¼ì²´/OODì— ëŒ€í•œ ê±°ì ˆ ì„±ëŠ¥ í•„ìˆ˜

## 2. ì•„í‚¤í…ì²˜ ê°œìš”

* **Backbone**: ViT-B/16(ê¸°ë³¸) ë˜ëŠ” ConvNeXt-Tiny â€” ì „ì´í•™ìŠµ
* **í—¤ë“œ**: (A) Softmax ë¶„ë¥˜ í—¤ë“œ + (B) Metric ì„ë² ë”© í—¤ë“œ(ArcFace/Triplet)
* **ê²°ì • ë¡œì§**:

  1. Top-1 ì ìˆ˜ â‰¥ Tì´ë©´ Accept
  2. ì•„ë‹ˆë©´ ì„ë² ë”© ìµœê·¼ì ‘ ê±°ë¦¬ d < Dì´ë©´ Accept(ì„¸ì»¨ë“œ ì˜¤í”¼ë‹ˆì–¸)
  3. ë‘˜ ë‹¤ ë¯¸ë‹¬ ì‹œ Recollect
* **ì¸ë±ìŠ¤**: ì „ì‹œí’ˆë³„ ëŒ€í‘œ ì„ë² ë”©(ë˜ëŠ” ëª¨ë“  ìƒ˜í”Œ)ìœ¼ë¡œ FAISS/ScaNN ì¸ë±ìŠ¤ êµ¬ì¶•

## 3. ë°ì´í„° íŒŒì´í”„ë¼ì¸

* ë¡œë”: `data/{place}/{item}/*.jpg`
* ì „ì²˜ë¦¬: EXIF ì •ê·œí™”, í•´ìƒë„ ì œí•œ(ê¸´ ë³€ 1024), ë¼ë²¨ ê²€ì¦, ì¤‘ë³µ ì œê±°(pHash)
* ì¦ê°•: RandomResizedCrop, ColorJitter, HFlip, GaussianBlur, RandomGray (ì‹¤ì „ ì´¬ì˜ ë‹¤ì–‘ì„± ë°˜ì˜)
* ë¶ˆê· í˜• ë³´ì •: í´ë˜ìŠ¤ ê°€ì¤‘ì¹˜ + ìƒ˜í”ŒëŸ¬ + MixUp/CutMix(ì„ íƒ)

## 4. í•™ìŠµ ì „ëµ

* ì†ì‹¤: `CE + ArcFace(ë˜ëŠ” Triplet)` ë©€í‹°-ì˜¤ë¸Œì í‹°ë¸Œ
* ìŠ¤ì¼€ì¤„ëŸ¬: Cosine with warmup, EMA(ì„ íƒ)
* ì²´í¬í¬ì¸íŠ¸: `best_top1`, `best_auroc_reject`, `last`
* ê²€ì¦: ì¥ì†Œ ë‚´/ì¥ì†Œ ê°„ ë¶„ë¦¬(ë„ë©”ì¸ ì¼ë°˜í™” ì²´í¬)
* í•˜ë“œ ë„¤ê±°í‹°ë¸Œ ë§ˆì´ë‹: Epoch N ì´í›„, ìƒí˜¸ í˜¼ë™ ìŒ ì¬ê°€ì¤‘

## 5. ì¶”ë¡  ë¡œì§ ì„¸ë¶€

1. Softmax í™•ë¥  `p_top1`, `margin = p1 - p2`
2. ì„ë² ë”© ê±°ë¦¬ `d_top1`
3. ê·œì¹™:

```text
if p_top1 >= T and margin >= M: accept
elif d_top1 <= D: accept
else: recollect
```

* ê¸°ë³¸ê°’: `T=0.62, M=0.12, D=0.65` (ë°ì´í„°ë¡œ ì¬íŠœë‹)
* íŒíŠ¸ ìƒì„±: ê°ì§€ëœ ë¸”ëŸ¬/ë…¸ì¶œ/í”„ë ˆì„ì˜¤í”„ì„¼í„° ê¸°ë°˜ ê·œì¹™

## 6. íŒ¨í‚¤ì§€ êµ¬ì¡°

```
ai_lens_helper/
  __init__.py
  cli.py
  config/
  data/
  models/
    backbones.py
    heads.py
    losses.py
  train/
    datamodule.py
    engine.py
    evaluator.py
    export.py
  infer/
    runner.py
    postprocess.py
    quality_check.py
    index.py
  utils/
    io.py
    metrics.py
    vis.py
```

## 7. CLI ì„¤ê³„

* `ai-lens validate-data --data-root ./data`
* `ai-lens train ...` (ìœ„ README ì°¸ì¡°)
* `ai-lens build-index --model ckpt --data-root ./data/A --place A --save ./A.index`
* `ai-lens infer --model ckpt --place A --image path.jpg --reject-threshold 0.62`
* `ai-lens infer-batch --model ckpt --place A --input-dir ./folder`
* `ai-lens export --ckpt best.ckpt --onnx out.onnx`

## 8. í‰ê°€/ë¦¬í¬íŒ…

* í˜¼ë™í–‰ë ¬ + ì˜¤ë¶„ë¥˜ Top-N ì‹œê°í™”(ë¦¬ì½œ ë‚®ì€ í´ë˜ìŠ¤ ì ê²€)
* OOD ìƒ˜í”Œ(ê´€ëŒê°, ë²½, ë°”ë‹¥, ì•ˆë‚´ë¬¸) ì„¸íŠ¸ë¡œ Reject ROC ì¸¡ì •
* ë¦¬í¬íŠ¸ HTML ìë™ ìƒì„± + JSON ìš”ì•½(ë°°í¬ íŒŒì´í”„ë¼ì¸ ì…ë ¥)

## 9. ë°°í¬ & ìµœì í™”

* ONNX ë³€í™˜, Dynamic Quantization
* ë°°ì¹˜ ì¶”ë¡  ì‹œ ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ìºì‹œ / ë©€í‹°í”„ë¡œì„¸ìŠ¤
* ì¸ë±ìŠ¤ ë©”ëª¨ë¦¬ë§µ + warmup

## 10. í’ˆì§ˆ/ì¬í˜„ì„±

* Seed ê³ ì •, ë²„ì „/ì˜ì¡´ì„± Lock, ëª¨ë¸/ì„¤ì •/ë°ì´í„° í•´ì‹œ ê¸°ë¡
* CI: lint, type-check, unit/CLI í…ŒìŠ¤íŠ¸, ìƒ˜í”Œ ë°ì´í„°ë¡œ 1epoch ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸

## 11. ë³´ì•ˆ/í”„ë¼ì´ë²„ì‹œ

* ë¯¼ê°ì •ë³´ ë¯¸ìˆ˜ì§‘, íŒŒì¼ ê²½ë¡œ/EXIFì—ì„œ PII ì œê±° ì˜µì…˜

## 12. ì¼ì •(ì˜ˆì‹œ)

* W1: ìŠ¤ìºí´ë”©/ë°ì´í„° ë°¸ë¦¬ë°ì´í„°/ê¸°ë³¸ ë¡œë”
* W2: í•™ìŠµì—”ì§„(ë¶„ë¥˜+ì„ë² ë”©), ê¸°ë³¸ CLI
* W3: í‰ê°€/ë¦¬í¬íŠ¸/Reject ë¡œì§ ê³ ë„í™”
* W4: ë°°í¬(ONNX)/ì¸ë±ìŠ¤/ë¬¸ì„œí™”

---

## ğŸ¤– AIì—ê²Œ ë§¡ê¸¸ í”„ë¡¬í”„íŠ¸ (ì˜ˆì‹œ)

### (A) ë°ì´í„° ì •ì œ/ì¦ê°• ì œì•ˆ í”„ë¡¬í”„íŠ¸

```
ë‹¹ì‹ ì€ ì»´í“¨í„°ë¹„ì „ í•™ìŠµ ë°ì´í„° íë ˆì´í„°ì…ë‹ˆë‹¤. ì•„ë˜ í´ë” êµ¬ì¡°ì˜ ì „ì‹œí’ˆ ì´ë¯¸ì§€ë¥¼ ê²€í† í•˜ê³ ,
1) ì¤‘ë³µ/ì €í™”ì§ˆ íƒì§€ ê¸°ì¤€, 2) ê¶Œì¥ ì¦ê°• íŒŒì´í”„ë¼ì¸(ì´¬ì˜ í™˜ê²½ ë‹¤ì–‘í™” ì¤‘ì‹¬),
3) í´ë˜ìŠ¤ ë¶ˆê· í˜• ë³´ì • ì „ëµì„ YAMLë¡œ ì œì•ˆí•˜ì„¸ìš”.
ì œì•½: ê° ì „ì‹œí’ˆ ìµœì†Œ 10ì¥, ì‹¤ë‚´ ë°•ë¬¼ê´€ ì¡°ëª…/ë°˜ì‚¬ ê³ ë ¤.
```

### (B) í•˜ì´ë¸Œë¦¬ë“œ ì¶”ë¡  ê·œì¹™ íŠœë‹ í”„ë¡¬í”„íŠ¸

```
ë‹¹ì‹ ì€ ëª¨ë¸í‰ê°€ ì—”ì§€ë‹ˆì–´ì…ë‹ˆë‹¤. Softmax ì ìˆ˜(p_top1, margin)ì™€ ì„ë² ë”© ê±°ë¦¬(d_top1) ê¸°ë°˜ì˜
accept/recollect ê²°ì • ì„ê³„ì¹˜ (T, M, D)ë¥¼ ê°œë°œ/ê²€ì¦ ì„¸íŠ¸ ë¶„í¬ë¥¼ ê·¼ê±°ë¡œ ì‚°ì¶œí•˜ê³ ,
Reject AUROCë¥¼ ìµœëŒ€í™”í•˜ëŠ” ì¡°í•©ì„ ì œì•ˆí•˜ì„¸ìš”. ìµœì¢… í‘œ í˜•íƒœì™€ ê·¼ê±° ê·¸ë˜í”„ ì„¤ëª…ì„ í¬í•¨í•˜ì„¸ìš”.
```

### (C) í•˜ë“œ ë„¤ê±°í‹°ë¸Œ ë§ˆì´ë‹ í”„ë¡¬í”„íŠ¸

```
ë‹¹ì‹ ì€ ëª¨ë¸í›ˆë ¨ ê³ ë„í™” ì—”ì§€ë‹ˆì–´ì…ë‹ˆë‹¤. ì•„ë˜ í˜¼ë™í–‰ë ¬ê³¼ Top-ì˜¤ë¶„ë¥˜ ìƒ˜í”Œ ë¬¶ìŒì„ ë¶„ì„í•˜ì—¬,
ì„œë¡œ ìì£¼ í˜¼ë™ë˜ëŠ” ì „ì‹œí’ˆ ìŒì— ëŒ€í•œ í•˜ë“œ ë„¤ê±°í‹°ë¸Œ ë§ˆì´ë‹ ì ˆì°¨(é‡‡æ ·/ì¦ê°•/ë¡œìŠ¤ ê°€ì¤‘)ë¥¼ ì œì‹œí•˜ì„¸ìš”.
Epochë³„ ì ìš© ìŠ¤ì¼€ì¤„ê³¼ ê¸°ëŒ€ ì„±ëŠ¥ í–¥ìƒ í­ì„ ìˆ˜ì¹˜ë¡œ ì¶”ì •í•˜ì„¸ìš”.
```

### (D) ì˜¨ë””ë°”ì´ìŠ¤ ìµœì í™” í”„ë¡¬í”„íŠ¸

```
ë‹¹ì‹ ì€ ëª¨ë¸ê²½ëŸ‰í™” ì—”ì§€ë‹ˆì–´ì…ë‹ˆë‹¤. í˜„ì¬ PyTorch ckptë¥¼ ONNXë¡œ ë³€í™˜í•œ í›„,
CPU/ëª¨ë°”ì¼ì—ì„œì˜ ì§€ì—°ì‹œê°„ê³¼ ë©”ëª¨ë¦¬ë¥¼ ì¤„ì´ê¸° ìœ„í•œ í›„ì²˜ë¦¬(ì–‘ìí™”/ì—°ì‚° Fusion/ì…ë ¥í¬ê¸° ì¡°ì •)ë¥¼
ë²¤ì¹˜ë§ˆí¬ í…Œì´ë¸”ê³¼ í•¨ê»˜ ì œì•ˆí•˜ì„¸ìš”. í’ˆì§ˆ ì €í•˜ë¥¼ ìµœì†Œí™”í•˜ëŠ” ì„¤ì •ì„ ìš°ì„ í•˜ì„¸ìš”.
```

---

## âœ… ê²€ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸

* [ ] ë°ì´í„° í´ë” ê·œì•½ ì¤€ìˆ˜, í´ë˜ìŠ¤ë‹¹ â‰¥10ì¥
* [ ] `ai-lens validate-data` í†µê³¼
* [ ] K-fold + ì¥ì†Œ Holdout í‰ê°€ OK
* [ ] Reject ì„ê³„ì¹˜ íŠœë‹ ë° ë³´ê³ ì„œ ì•„ì¹´ì´ë¸Œ
* [ ] ONNX ë‚´ë³´ë‚´ê¸° ë° ìƒ˜í”Œ ì¶”ë¡  ì„±ê³µ
* [ ] README ë°°í¬ ê°€ì´ë“œ ìµœì‹ í™”
